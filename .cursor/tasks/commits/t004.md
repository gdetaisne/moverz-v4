# Commits pour t004

## [Ã€ venir] â€” t004: Fixe connexions PostgreSQL perdues (Connection reset)
**Date** : 2025-11-10  
**Auteur** : AI Assistant

### Changements
- Ajoute graceful shutdown au client Prisma (SIGINT/SIGTERM/beforeExit)
- Configure datasource explicitement dans PrismaClient
- Ajoute directUrl dans schema.prisma pour migrations
- Documente configuration DATABASE_URL avec connection pooling

### Fichiers modifiÃ©s
- `lib/db.ts` : Graceful shutdown + datasource config
- `packages/core/src/db.ts` : MÃªme amÃ©lioration
- `prisma/schema.prisma` : Ajout directUrl
- `docs/database-url-configuration.md` : Guide complet config CapRover
- `.cursor/tasks/t004-fix-postgres-connection-reset.md` : Documentation solution

### Contexte
Erreurs rÃ©currentes "Connection reset by peer" dues Ã  :
1. Pool non configurÃ© â†’ trop de connexions simultanÃ©es
2. Connexions idle non gÃ©rÃ©es â†’ timeout PostgreSQL
3. Shutdown brutal â†’ connexions coupÃ©es lors redÃ©marrage
4. Pas de retry â†’ erreurs rÃ©seau temporaires

### Solution technique

**Code (graceful shutdown) :**
```typescript
process.on('SIGINT', shutdownHandler);
process.on('SIGTERM', shutdownHandler);
process.on('beforeExit', async () => {
  await prisma.$disconnect();
});
```

**Variables CapRover (action manuelle requise) :**
```
DATABASE_URL=postgresql://...?connection_limit=10&pool_timeout=20&connect_timeout=15&socket_timeout=60
DIRECT_URL=postgresql://...?connection_limit=10&connect_timeout=15
```

### Impact
âœ… RedÃ©marrage propre sans interruption brutale
âœ… Connexions DB gÃ©rÃ©es correctement
âœ… Moins d'erreurs "Connection reset by peer"
âœ… Migrations plus stables avec directUrl

### Notes
âš ï¸ NÃ©cessite mise Ã  jour manuelle des variables CapRover
ğŸ“– Voir docs/database-url-configuration.md pour guide dÃ©taillÃ©

---
